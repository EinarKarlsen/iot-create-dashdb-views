-- View that contains the last set of event data for every Elevator

CREATE VIEW DASH6769.VW_ELEVATOR_STATUS (
  DEVICEID,
  DEVICETYPE, 
  MOTORTEMP, 
  CABINSPEED,
  CABINTEMP,
  CURRENTFLOOR,
  DIRECTION,
  DOOROPEN,
  LOAD,
  MAINTENANCEREASON,
  MAINTENANCESTOP,
  NUMBEROFFLOORS,
  STATE,
  TIMESTAMP,
  DATE,
  TIME
 ) AS
SELECT 
  ee.DEVICEID, 
  ee.DEVICETYPE,
  ROUND(ee.MOTORTEMP) AS MOTORTEMP,
  ee.CABINSPEED,
  ee.CABINTEMP,
  ee.CURRENTFLOOR,
  ee.DIRECTION,
  ee.DOOROPEN,
  ee.LOAD,
  ee.MAINTENANCEREASON,
  ee.MAINTENANCESTOP,
  ee.NUMBEROFFLOORS,
  ee.STATE,
  ee.TIMESTAMP,
  DATE(substring(ee.TIMESTAMP,1,10)) AS DATE,
  TIME(substring(ee.TIMESTAMP,12,8)) AS TIME
FROM DASH6769.ELEVATOR_EVENTS ee 
JOIN (
   SELECT 
      DEVICEID, 
      DEVICETYPE,
      MAX(TIMESTAMP) AS TIMESTAMP
   FROM DASH6769.ELEVATOR_EVENTS de1
   GROUP BY DEVICEID, DEVICETYPE 
) lee 
ON ee.DEVICEID = lee.DEVICEID AND ee.TIMESTAMP = lee.TIMESTAMP;

-- View that contains accumulated motor temperatures on a day by day basis

CREATE VIEW DASH6769.VW_ELEVATOR_EVENTS_BY_DAY (
   DEVICEID, 
   DEVICETYPE,
   MINMOTORTEMP,
   AVGMOTORTEMP,
   MAXMOTORTEMP,
   DATE  
) AS
SELECT 
   DEVICEID, 
   DEVICETYPE,
   ROUND(MIN(MOTORTEMP)) AS MINMOTORTEMP,
   ROUND(AVG(MOTORTEMP)) AS AVGMOTORTEMP,
   ROUND(MAX(MOTORTEMP)) AS MAXMOTORTEMP,
   DATE(substring(TIMESTAMP,1,10)) AS DATE
FROM DASH6769.ELEVATOR_EVENTS
GROUP BY DEVICEID, DEVICETYPE, DATE(substring(TIMESTAMP,1,10)); 


-- View that shows the elevator alerts that have been generated over time

CREATE VIEW DASH6769.VW_ELEVATOR_ALERTS (
   DEVICEID,
   DEVICETYPE,
   CABINSPEED,
   CABINTEMP,
   CURRENTFLOOR,
   DIRECTION,
   DOOROPEN,
   LOAD,
   MAINTENANCEREASON,
   MAINTENANCESTOP,
   MOTORTEMP,
   TIMESTAMP,
   DATE,
   TIME
) AS 
SELECT
   DEVICEID,
   DEVICETYPE,
   CABINSPEED,
   CABINTEMP,
   CURRENTFLOOR,
   DIRECTION,
   DOOROPEN,
   LOAD,
   MAINTENANCEREASON,
   MAINTENANCESTOP,
   MOTORTEMP,
   TIMESTAMP,
   DATE(substring(TIMESTAMP,1,10)) AS DATE,
   TIME(substring(TIMESTAMP,12,8)) AS TIME
FROM DASH6769.ELEVATOR_ALERTS_NR;
